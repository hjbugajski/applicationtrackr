<mat-toolbar class="absolute-toolbar">
  <button mat-button class="mat-button-with-left-icon" (click)="goBack()">
    <mat-icon svgIcon="carbon-arrow-left"></mat-icon>
    Back
  </button>
  <div class="spacer"></div>
  <button mat-button class="mat-button-with-right-icon" (click)="signOut()">
    Sign out
    <mat-icon svgIcon="carbon-logout"></mat-icon>
  </button>
</mat-toolbar>
<mat-sidenav-container>
  <div class="content">
    <mat-card>
      <mat-card-title>Settings</mat-card-title>

      <mat-divider></mat-divider>

      <ng-container *ngIf="!user; else settings">
        <div class="spinner-container">
          <mat-spinner [diameter]="48" color="accent"></mat-spinner>
        </div>
      </ng-container>

      <ng-template #settings>
        <h2 class="mat-card-secondary-title">Application</h2>
        <mat-list>
          <div matSubheader>Appearance</div>
          <at-theme-picker layout="list"></at-theme-picker>
        </mat-list>
        <mat-divider></mat-divider>

        <h2 class="mat-card-secondary-title">Account</h2>

        <div class="account-details">
          <mat-icon svgIcon="carbon-user-avatar" class="account-details-avatar"></mat-icon>
          <div class="account-details-email">{{ user!.email }}</div>
          <div class="mat-caption">Signed in with {{ providerDisplay }}</div>
        </div>

        <ng-container *ngIf="provider === providers.Password">
          <!-- Update email address -->
          <mat-list>
            <div matSubheader>Update email address</div>
            <mat-list-item>
              <div class="full-width">
                <form
                  #updateEmailFormDirective="ngForm"
                  [formGroup]="updateEmailForm"
                  (ngSubmit)="updateUserEmail(updateEmailFormDirective)"
                  class="full-width"
                >
                  <mat-form-field class="full-width">
                    <mat-label>New email address</mat-label>
                    <input formControlName="newEmail" matInput type="email" required />
                    <mat-error>{{ getEmailError(newEmail) }}</mat-error>
                  </mat-form-field>
                  <mat-form-field class="full-width">
                    <mat-label>Password</mat-label>
                    <input formControlName="password" matInput type="password" required />
                    <mat-error>{{ getEmailError(password) }}</mat-error>
                  </mat-form-field>
                  <button
                    mat-flat-button
                    color="primary"
                    [disabled]="isUpdateEmailLoading"
                    type="submit"
                    class="full-width"
                  >
                    <div *ngIf="isUpdateEmailLoading" class="loading-spinner-in-button">
                      <mat-spinner color="accent" diameter="24"></mat-spinner>
                    </div>
                    <ng-container *ngIf="!isUpdateEmailLoading">Update</ng-container>
                  </button>
                </form>
              </div>
            </mat-list-item>

            <!-- Update password -->
            <div matSubheader>Update password</div>
            <mat-list-item>
              <at-reset-password-form
                [authMode]="authModes.Update"
                buttonText="Update"
                [email]="user!.email ?? ''"
              ></at-reset-password-form>
            </mat-list-item>

            <!-- Forgot password -->
            <div matSubheader>Forgot password</div>
            <mat-list-item>
              <at-forgot-password-form
                [emailValue]="user?.email!"
                [readonly]="true"
                hint="This field cannot be modified"
                class="full-width"
              ></at-forgot-password-form>
            </mat-list-item>
          </mat-list>
        </ng-container>

        <mat-divider></mat-divider>

        <h2 class="mat-card-secondary-title at-error at-text">Danger zone</h2>
        <!-- Delete account -->
        <mat-list>
          <div matSubheader>Delete account</div>
          <at-alert class="at-error at-text" [color]="colors.Error">
            <div message>
              This action will delete your account and all data associated with your account. This action cannot be
              undone. Your account and data cannot be recovered.
            </div>
          </at-alert>
          <mat-stepper orientation="vertical" color="warn" [linear]="true" #authStepper>
            <!-- Step 1: Re-authenticate -->
            <mat-step [editable]="false" [completed]="stepOneCompleted">
              <ng-template matStepLabel>Re-authenticate</ng-template>
              <ng-template matStepContent>
                <ng-container [ngSwitch]="provider">
                  <!-- Apple provider -->
                  <at-sign-in-with-apple-button
                    *ngSwitchCase="providers.Apple"
                    [authMode]="authModes.Reauthenticate"
                    prefix="Sign in"
                    (reauthenticated)="goToNextStep(authStepper)"
                  ></at-sign-in-with-apple-button>

                  <!-- Google provider -->
                  <at-sign-in-with-google-button
                    *ngSwitchCase="providers.Google"
                    [authMode]="authModes.Reauthenticate"
                    prefix="Sign in"
                    (reauthenticated)="goToNextStep(authStepper)"
                  ></at-sign-in-with-google-button>

                  <!-- Password provider -->
                  <at-sign-in-with-password-form
                    *ngSwitchCase="providers.Password"
                    [authMode]="authModes.Reauthenticate"
                    buttonColor="warn"
                    buttonText="Re-authenticate"
                    [showForm]="true"
                    (reauthenticated)="goToNextStep(authStepper)"
                  ></at-sign-in-with-password-form>
                </ng-container>
              </ng-template>
            </mat-step>

            <!-- Step 2: Confirm deletion -->
            <mat-step [editable]="false">
              <ng-template matStepLabel>Confirm deletion</ng-template>
              <ng-template matStepContent>
                <p>To delete your account, type <span class="at-error at-text">delete account and data</span>.</p>
                <form (ngSubmit)="deleteUser()">
                  <mat-form-field class="full-width">
                    <mat-label>Confirmation</mat-label>
                    <input
                      [formControl]="confirmDeleteControl"
                      matInput
                      type="text"
                      placeholder="delete account and data"
                      required
                    />
                    <mat-error>{{ getConfirmDeleteError() }}</mat-error>
                  </mat-form-field>
                  <button mat-flat-button color="warn" type="submit" [disabled]="isLoading" class="full-width">
                    <div *ngIf="isLoading" class="loading-spinner-in-button">
                      <mat-spinner color="accent" diameter="24"></mat-spinner>
                    </div>
                    <ng-container *ngIf="!isLoading">Delete</ng-container>
                  </button>
                </form>
              </ng-template>
            </mat-step>
          </mat-stepper>
        </mat-list>
      </ng-template>
    </mat-card>
  </div>
</mat-sidenav-container>
